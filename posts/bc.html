<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Strips from the BQNcrate</title>
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="../assets/style.css"/>
<link rel="icon" href="../assets/favicon.ico" type="image/x-icon">
<style>
mjx-container[jax="CHTML"] {
overflow-x: auto !important;
}
</style>
<!-- Post-specific setting bellow -->
<style>
#table-of-contents > h2 { display: none; } /* Hide the default TOC heading */
#table-of-contents > ul { display: block; } /* Ensure TOC content is shown */
</style>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Strips from the BQNcrate</h1>
<p>
The <a href="https://mlochbaum.github.io/bqncrate/">BQNcrate</a> is an useful tool for learning and honing BQN skills, though not all of its entries are easy to understand.
Personally, I always prefer a shorter implementation if it's possible to maintain the same time complexity.
For this post, I have chosen three examples that fall into that specific category of code where you can read every primitive,
know exactly what each one does, but still miss the emergent behavior of the composition.
</p>

<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org385c29f">Topological sort</a></li>
<li><a href="#org80ca877">The _‚Äãwhile_ modifier</a></li>
<li><a href="#orgf84f8bf">Levenshtein distance</a></li>
</ul>
</div>
</div>
<div id="outline-container-org385c29f" class="outline-2">
<h2 id="org385c29f">Topological sort</h2>
<div class="outline-text-2" id="text-org385c29f">
<p>
Seeing this implementation of <a href="https://en.wikipedia.org/wiki/Topological_sorting#Kahn's_algorithm">Kahn's algorithm</a> for the first time is not for the faint of heart:
</p>

<div class="org-src-container">
<pre class="src src-bqn">TC ‚Üê {{ùïä‚çü(ùï©&lt;‚óã‚â†‚ä¢)‚üú(ùï©‚àæ¬∑/ùï®‚ä∏&lt;)ùï®‚à®‚àß¬¥‚àò‚äè‚üúùï®¬®p}‚üú/0¬®p‚Üêùï©}
</pre>
</div>

<p>
To understand dense, beautiful code like this, a good first step is to refactor it into smaller block functions
and named variables. Let's deconstruct the magic:
</p>

<div class="org-src-container">
<pre class="src src-bqn">TCS ‚Üê {ùïägraph:
  result‚Äømask ‚Üê ‚ü®‚ü© ‚ãà 0¬®graph
  Sort ‚Üê {mùïär:
    n ‚Üê m‚à®ready ‚Üê {‚àß¬¥ùï©‚äèm}¬®graph
    n ùïä‚çü(ùï©‚ä∏‚â¢) r‚àæ/m&lt;ready
  }
  mask Sort result
}
</pre>
</div>

<p>
Let's verify our refactoring is equivalent to the original. The input for both functions is a list of lists
representing the dependency graph: each index is a task, and its corresponding element is a list of
its prerequisites. For example:
</p>

<div class="org-src-container">
<pre class="src src-bqn">graph ‚Üê ‚ü®‚ü©‚Äø‚ü®‚ü©‚Äø‚ü®0‚ü©‚Äø‚ü®0,1‚ü©‚Äø‚ü®2,3‚ü©‚Äø‚ü®4‚ü©‚Äø‚ü®4‚ü©‚Äø‚ü®1,5,6‚ü©
</pre>
</div>

<p>
And then:
</p>

<div class="org-src-container">
<pre class="src src-bqn">(TC‚â°TCS) graph
</pre>
</div>

<pre class="example">
1
</pre>


<p>
Looks good. So, how does this more "readable" version work? The algorithm's state is propagated through two variables:
a "can-be-built" boolean mask <code>m</code>, initially all false, and the final sorted list <code>s</code>,
initially empty (indices <code>/</code> of a zeros' list is an empty list).
</p>

<p>
The <code>Sort</code> function then begins its iterative process. Inside, it first identifies the ready nodes: those whose
prerequisites are all satisfied by the current mask <code>m</code>. In the first step, this naturally selects nodes with
no prerequisites <code>‚ü®‚ü©</code>, which unlocks the next layer of dependencies. The new "can-be-built" mask <code>n</code> is the union
of the old mask and the newly ready nodes, ensuring it grows monotonically.
</p>

<p>
Crucially, the result list is extended only with the nodes that just became available. This new layer is
isolated with the differential comparison <code>m&lt;n</code> (<code>m&lt;ready</code> also works, since <code>n‚â°m‚à®ready</code>), and their
indices <code>/</code> are appended to the result before recurring with the updated state. The process repeats until a pass yields
no new nodes, completing the sort.
</p>
</div>
</div>
<div id="outline-container-org80ca877" class="outline-2">
<h2 id="org80ca877">The _‚Äãwhile_ modifier</h2>
<div class="outline-text-2" id="text-org80ca877">
<p>
This one was infamously hard for me to grasp, and reading its <a href="https://mlochbaum.github.io/BQN/doc/control.html#low-stack-version">docs</a> didn't clarify much at first. To understand it,
you need to be familiar with a fair bit of BQN, especially the functional programming and combinators aspects.
What makes it so complicated is the use of modifier recursion, which I will try to break down here.
</p>

<p>
An unrolling of the first two steps reveals that up to <code>2‚ãÜn</code> evaluations of <code>ùîΩ</code> can occur at recursion
level <code>n</code>. This is derived by noting that, within the BQN combinator, the left function of the
rightmost atop dictates that the <code>ùîΩ</code> for the subsequent step is, in accordance to <code>ùîΩ_ùï£_ùîæ</code>:
</p>

<div class="org-src-container">
<pre class="src src-bqn">_w0_ ‚Üê {ùîΩ‚çüùîæ‚àòùîΩ_ùï£_ùîæ‚àòùîΩ‚çüùîæùï©}
_w1_ ‚Üê {(ùîΩ‚çüùîæ‚àòùîΩ)‚çüùîæ‚àò(ùîΩ‚çüùîæ‚àòùîΩ)_w0_ùîæ‚àò(ùîΩ‚çüùîæ‚àòùîΩ)‚çüùîæùï©}
_w2_ ‚Üê {((ùîΩ‚çüùîæ‚àòùîΩ)‚çüùîæ‚àò(ùîΩ‚çüùîæ‚àòùîΩ))‚çüùîæ‚àò((ùîΩ‚çüùîæ‚àòùîΩ)‚çüùîæ‚àò(ùîΩ‚çüùîæ‚àòùîΩ))_w0_ùîæ‚àò((ùîΩ‚çüùîæ‚àòùîΩ)‚çüùîæ‚àò(ùîΩ‚çüùîæ‚àòùîΩ))‚çüùîæùï©}
</pre>
</div>

<p>
Another way to clarify the concept is to implement the same logic both as a function
and as a 1-modifier, and then compare these implementations with the two 2-modifiers
(one exhibiting linear and the other a logarithmic number of stack frames):
</p>

<div class="org-src-container">
<pre class="src src-bqn">Whiles ‚Üê {F‚ÄøGùïäùï©:
  Wfun ‚Üê {ùïé‚çüG‚àòùïéÀô‚ä∏ùïä‚àòùïé‚çüGùï©}
  _wom ‚Üê {ùîΩ‚çüG‚àòùîΩ_ùï£‚àòùîΩ‚çüGùï©}
  _wtmlog_ ‚Üê {ùîΩ‚çüùîæ‚àòùîΩ_ùï£_ùîæ‚àòùîΩ‚çüùîæùï©}
  _wtmlin_ ‚Üê {ùïä‚àòùîΩ‚çüùîæùï©}
  ‚ü®f Wfun ùï©, f _wom ùï©, f _wtmlog_ g ùï©, f _wtmlin_ g ‚éä"SO"ùï©‚ü©
}
</pre>
</div>

<p>
Let‚Äôs test it with a simple iteration that exceeds CBQN‚Äôs recursion limit, triggering a stack overflow:
</p>

<div class="org-src-container">
<pre class="src src-bqn">‚ü®1‚ä∏+, 5000‚ä∏‚â•‚ü© Whiles 0
</pre>
</div>

<pre class="example">
‚ü® 5001 5001 5001 "SO" ‚ü©
</pre>
</div>
</div>
<div id="outline-container-orgf84f8bf" class="outline-2">
<h2 id="orgf84f8bf">Levenshtein distance</h2>
<div class="outline-text-2" id="text-orgf84f8bf">
<p>
The Levenshtein (or edit) <a href="https://en.wikipedia.org/wiki/Levenshtein_distance">distance</a> is a measure of the similarity between two strings. It is defined
by the following recurrence, which is the basis of dynamic programming algorithms like Wagner-Fisher:
</p>

\begin{align*}
  d_{i0} &= i, \quad d_{0j} = j, \\
  d_{ij} &= \min \begin{cases} d_{i-1,j-1} + \mathbf{1}_{s_i \neq t_j} \\ d_{i-1,j} + 1 \\ d_{i,j-1} + 1 \end{cases}
\end{align*}

<p>
The Wagner-Fisher variant in the BQNcrate can be derived by shifting the distance matrix.
Given two strings \(s\) and \(t\) of lengths \(n\) and \(m\), respectively,
we define a new distance matrix as follows:
</p>

\begin{equation*}
  p_{ij} = d_{ij} + n - i + m - j
\end{equation*}

<p>
Under this transformation, the recurrence relation becomes:
</p>

\begin{align*}
  p_{i0} &= p_{0j} = m + n, \\
  p_{ij} &= \min \begin{cases} p_{i-1,j-1} + \mathbf{1}_{s_i \neq t_j} - 2 \\ p_{i-1,j} \\ p_{i,j-1} \end{cases}
\end{align*}

<p>
The above recurrence can be easily identified in the 3-train's middle function, which is
folded over the table of the costs (table comparing the characters).
Note that we compare insertions and substitutions, and then we can do a min scan
over the result to get the deletions, which gives a vectorised implementation.
</p>

<p>
An interesting part of this solution is the construction of the cost table,
which is done by reversing \(t\). Given that the final result for  \(p_{ij}\) ‚Äã is located
in the bottom-right corner and we use <code>foldr</code>, I would have expected \(s\) to be the
one reversed instead. However, both methods are functionally equivalent, as the following
stochastic test suggests:
</p>

<div class="org-src-container">
<pre class="src src-bqn">_l ‚Üê {¬Ø1‚äë(1‚ä∏+‚•ä+)‚óã‚â†(‚åä`‚ä¢‚åä‚äè‚ä∏¬ª‚àò‚ä¢-0‚àæ1+‚ä£)ÀùùîΩ}
T ‚Üê ‚åΩ‚ä∏(=‚åú)_l‚â°=‚åú‚üú‚åΩ_l
T‚óã{@+97+ùï©‚Ä¢rand.Range 25}¬¥ 1e4‚Äø1e5
</pre>
</div>

<pre class="example">
1
</pre>


<p>
The reason both approaches work lies in the inherent symmetries of the Levenshtein distance:
</p>

<ul class="org-ul">
<li>\(L(s,t) = L(t,s)\)</li>
<li>\(L(s,t) = L(\text{rev}(s),\text{rev}(t))\)</li>
<li>\(L(\text{rev}(s),t) = L(s,\text{rev}(t))\)</li>
</ul>

<div style="text-align: center; font-size: 2em; padding: 20px 0;">
  <a href="https://panadestein.github.io/blog/" style="text-decoration: none;">‚äë‚àò‚àû</a>
</div>
</div>
</div>
</div>
</body>
</html>
