blasFFI â† (âŠ£â€¢FFIÂ·(1-Ëœ+`Ã—Â¬)âˆ˜=âŸœâŠâŠ¸âŠ”âŠ¢)Â´ âŸ¨
  "/lib/libcblas.so"âˆ¾Ëœâ€¢BQN 1âŠ‘â€¢Sh "nix-instantiate"â€¿"--eval-only"â€¿"--expr"â€¿"(import <nixpkgs> {}).blas.outPath"
  " & cblas_dgemm u32 u32 u32 i32 i32 i32 f64 *f64 i32 *f64 i32 f64 &f64 i32"
âŸ©
Dgemm â† {BlasFFI 101â€¿111â€¿111â€¿mâ€¿nâ€¿kâ€¿1â€¿ğ•¨â€¿kâ€¿ğ•©â€¿nâ€¿0â€¿(mâ€¿nâ¥Š0)âˆ¾âŠ¢Â´mâ€¿kâ€¿Â·â€¿nâ†ğ•¨âˆ¾â—‹â‰¢ğ•©}

matâ€¿mbt â† âŸ¨â‹ˆËœ2â¥Š500, â‹ˆËœ5â¥Š600âŸ© /Â¨âŠ¸âŠ”Â¨ maâ€¿mb â† â€¢rand.RangeâŸœ0Â¨1e3Ã—âŸ¨1â€¿1, 3â€¿3âŸ©
>âŸ¨maâ€¿maâ€¿mat, mbâ€¿mbâ€¿mbtâŸ© {ğ•Ëœâ€¢_timedğ•©}Â¨Â¨Ëœ <âŸ¨Dgemm, +Ëâˆ˜Ã—â‰1â€¿âˆ, âˆ¾(+Ë+Ëâˆ˜Ã—â‰1â€¿âˆÂ¨)â‰1â€¿âˆâŸ©

MPB â† {ğ•©â‰¢âŠ¸â†‘âˆ¾(+Ë+Ëâˆ˜Ã—â‰1â€¿âˆÂ¨)â‰1â€¿âˆËœğ•©(â¥ŠâŸœğ•¨Â¨âˆ˜âŠ¢/Â¨âŠ¸âŠ”ğ•¨âŠ¸Ã—â†‘âŠ£)âŒˆğ•¨Ã·Ëœâ‰¢ğ•©}

(300+50Ã—â†•8) {ğ•¨âŠ¸MPBâ€¢_timedğ•©}Â¨ <3e3â€¿3e3 â€¢rand.Range 0

MPB2 â† {âˆ¾âˆ¾Ã—_pÂ¨_pÂ¨(_pâ†{+Ëâˆ˜ğ”½â‰1â€¿âˆ})Ëœğ•©{ğ•©âŠ”Ëœ/Â¨â¥ŠâŸœğ•¨Â¨âŒˆğ•¨Ã·Ëœâ‰¢ğ•©}Â´ğ•¨}
âŸ¨10â€¿60, 4â€¿250, 3â€¿500âŸ© {ğ•¨âŠ¸MPB2â€¢_timedğ•©}Â¨ <3e3â€¿3e3â€¢rand.Range 0

âŸ¨+Ëâˆ˜Ã—â‰1â€¿âˆ, 600âŠ¸MPB, +Ëâˆ˜Ã—â‰1â€¿âˆ _strassen_ 256, Dgemm _strassen_ 256, DgemmâŸ© {ğ•Ëœâ€¢_timedğ•©}Â¨ <4096â€¿4096â€¢rand.Range 0

âŸ¨mpiâŸ© â‡ â€¢Import "mpi.bqn"

mpi.Init@ â‹„ râ€¿s â† âŸ¨mpi.Rank@, mpi.Size@âŸ©

# Processor element coordinates in 2D grid (râ‰¡y+qÃ—x)
!âŒŠâŠ¸=qâ†âˆšs â‹„ b â† qÃ·Ëœn â† 2â‹†12 â‹„ xâ€¿y â† q(|â‹ˆËœÂ·âŒŠÃ·Ëœ)r

# Local matrices
aml â† (+Â´bâ€¿bÃ—xâ€¿y)++âŒœËœâ†•b
bml â† (-Â´bâ€¿bÃ—xâ€¿y)+-âŒœËœâ†•b

# Toroidal topology with periodic boundary conditions, (amlâ†) (bmlâ†‘)
Lâ€¿U â† {ğ•©âŠ¸mpi.SendrecvâŒ¾â¥Š}Â¨âŸ¨(qÃ—x)+q|y(-â‹ˆ+)1 â‹„ y+qÃ—q|x(-â‹ˆ+)1âŸ©

# Strassen algorithm with blocking for cache efficiency
_strassen_ â† {ğ•˜â‰¥â‰ ğ•© ? ğ•¨ğ”½ğ•©;
  [aâ€¿b,câ€¿d]â€¿[eâ€¿f,gâ€¿h] â† (2âŠ¸â¥ŠÂ¨âˆ˜âŠ¢/Â¨âŠ¸âŠ”2âŠ¸Ã—â†‘âŠ£)Â¨âŸœ(âŒˆ2Ã·Ëœâ‰¢Â¨)ğ•¨â€¿ğ•©
  p1â€¿p2â€¿p3â€¿p4â€¿p5â€¿p6â€¿p7 â† ğ•ŠÂ´Â¨âŸ¨a+d,e+hâŸ©â€¿âŸ¨c+d,eâŸ©â€¿âŸ¨a,f-hâŸ©â€¿âŸ¨d,g-eâŸ©â€¿âŸ¨a+b,hâŸ©â€¿âŸ¨c-a,e+fâŸ©â€¿âŸ¨b-d,g+hâŸ©
  ğ•©â‰¢âŠ¸â†‘âˆ¾âŸ¨p1+p4+p7-p5, p3+p5âŸ©â‰âŸ¨p2+p4, p1+p3+p6-p2âŸ©
}
MP â† +Ëâˆ˜Ã—â‰1â€¿âˆ _strassen_ 256

# Skewing
aml LâŸxâ†© â‹„ bml UâŸyâ†©

# Multiply and shift
cml â† +Â´{ğ•Š: amlâŠ¸MPâŸœbmlâŸ¨aml Lâ†© â‹„ bml Uâ†©âŸ©}Â¨â†•q

# Test (not included in benchmark)
cmf â† (+âŒœËœ+Ëâˆ˜Ã—â‰1â€¿âˆ-âŒœËœ)â†•n
!cmlâ‰¡râŠ‘â¥Šcmf/Â¨âŠ¸âŠ”Ëœâ‹ˆËœqâ¥Šb

mpi.Finalize@
